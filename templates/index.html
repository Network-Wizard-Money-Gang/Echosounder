<!DOCTYPE html>
<html lang='fr'>
  <head>
    <meta charset ="UTF-8">
  	<title>Calys</title>
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css')}}" />
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='vis.min.css')}}" />
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='vis-network.min.css')}}" />
    <script type="text/javascript" src="{{ url_for('static', filename='vis.min.js')}}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='vis-network.min.js')}}"></script>
  </head>
  <body id="backgroundquadrillage">
    <header>
      <center>Calys analyser</center>
    </header>

    <div id="mynetwork"></div>
    <style>
    :root {
      --background-color-black: #010b0d;
      --background-gradiance1 : #050c12;
      --background-gradiance2 : #0d1718;
      --widget-blue1 : #3e908e;
      --widget-blue2 : #2b6b6a;
      --widget-blue3 : #4b948c;
      --widget-red1 : #5c202a;
      --widget-red2 : #371921;
      --text1 : #a5b0a9;
      --text2 : #abd6db;
    };

    html {
      height: 100%;
      background-color: var(--background-color-black);
    }
    body {
      min-height: 100%;
      background-color: var(--background-color-black);
      background-image: linear-gradient(transparent 61px, rgba(75,148,140,0.3) 62px, transparent 62px),
                        linear-gradient(90deg, transparent 61px, rgba(75,148,140,0.3) 62px, transparent 62px);
      background-size: 100% 62px, 62px 100%;
    }

    header {
      background-color: var(--widget-blue2);
      color: var(--text1);
    }
    </style>
    <script type="text/javascript">
      // fonctionnalités de gestion des appels d'API
      let request = new XMLHttpRequest();

      // fonction de récupération d'un scan complet
      function requestAllData() {
        request.open('GET', "/json/fast_scan"); // on crée la requête
        request.responseType = 'json'; // on spécifie qu'on attends du json
        request.send(); // on envoie la requête
        request.onload = function() {
          let response = request.response;
          console.log(response);
          createGraph(response); // on envoie le retour du scan à la fonction de création du graph
        }
      };

      console.log("lancement d'un scan complet");
      requestAllData();

      // ici commence le vis.js
      // fonction de génération du graph, prenant un scan complet en entrée :
      function createGraph(scan_data) {
        // liste des noeuds
        let nodes = new vis.DataSet([]);

        // ajout de la gateway :
        nodes.add([
          {id: "gateway", label: ('gateway ' + scan_data.local_data[2]), color: 'rgba(62,144,142,0.8)', font: {color: "#a5b0a9"}},
        ]);

        // ajout des entités nmap :
        let i = 0;
        scan_data.scan.forEach(function(nodeAdd) {
          nodes.add([
            {id: i, label: (nodeAdd.IP + '\n' + nodeAdd.OS + '\n' + nodeAdd.mac), color: 'rgba(75,148,140,0.8)', font: {color: "#a5b0a9"}},
          ]);
          i++;
        });

        // liste des chemins
        let edges = new vis.DataSet([]);

        // liaison de toutes les entité nmap avec la gateway :
        for(i; i >= 0; i--) {
          edges.add([
            { from: i, to: "gateway" },
          ]);
        }

        // créaction de l'objet graph
        let container = document.getElementById("mynetwork");
        let data = {
          nodes: nodes,
          edges: edges,
        };
        let options = {
          height: getHeigthWindows80() + "px",
        };
        let network = new vis.Network(container, data, options);
      }

      // get windows size 80% :
      function getHeigthWindows80() {
        let heigth = window.innerHeight;
        heigth = heigth - (heigth/5);
        return heigth.toString();
      }
    </script>
  </body>
</html>
